# Preparing data for Rain Analysis

Objective: Join the forecasts (forecast.dat) and actuals (histWeather.csv) in preparation for analysis of forecast accuracy.

```{r, results='hide', message=FALSE, warning=FALSE}
library(tidyverse); library(data.table)
```

Importing datasets as data.tables
```{r}
hist_weather <- fread("data/histWeather.csv")
forecast <- fread("data/forecast.dat", sep=" ", header=F)
locations <- fread("data/locations.csv")
```


## Prepare Forecast data

Add column names and then new column for city names (city names come from "locations" dataframe).
```{r}
colnames(forecast) <- c("city_no", "target_date", "forecast_value", "forecast_type", "date_of_forecast")

forecast <- forecast %>% mutate(city = locations$city[match(city_no, row.names(locations))])
```

Converting factor columns to numeric and date.
```{r}
forecast$forecast_value <- as.numeric(forecast$forecast_value)
forecast$target_date <- as.Date(forecast$target_date, format = "%Y-%m-%d")
forecast$date_of_forecast <- as.Date(forecast$date_of_forecast, format = "%Y-%m-%d")
```

Forecasts came in long format, convert to wide and only keep 3 of the measurements: MaxTemp, MinTemp, PropPrecip. Spreading it changes dimensions, from 3191972 x 6 to 787,717 x 6.
```{r}
forecast$id <- 1:nrow(forecast)
forecast <- as.data.table(forecast)

forecast_wide <- dcast(forecast, city + target_date + date_of_forecast + id ~ forecast_type, 
                       value.var = "forecast_value", fun.aggregate = mean, na.rm=T)
```

Add forecast horizon variable (difference between target date and date forecast was made).
```{r}
forecast_2 <- na.omit(forecast_wide[,c(1:3,7)])

# Days_out: Calculating the forecast distance
forecast_2 <- mutate(forecast_2, Days_out= target_date - date_of_forecast)

# Remove Days_out that are -1 since it is nonsense
forecast_2 <- filter(forecast_2, Days_out > -1)

#Rename columns
colnames(forecast_2) <- c("city", "target_date", "date_of_forecast", "ProbPrecip_forecast", "Days_out")
```



## Prepare historical weather data (actuals)

Add city column.
```{r}
hist_weather <- hist_weather %>% 
  mutate(city = locations$city[match(AirPtCd, locations$AirPtCd)])
```

Denver appears to have an error: all PrecipIn observations equal 0. Not a good idea to make the 0's the average, because that could have an influential effect on rain error metrics, so Denver is removed.

Baltimore is missing eight metrics (not PrecipIn, though). Austin is also missing many metrics. However they are kept in because they have most of their data.

```{r}
hist_weather <- filter(hist_weather, city!="Denver")
```

Convert data types and column names to match forecast data.
```{r}
hist_weather$Date <- as.Date(hist_weather$Date,  format = "%Y-%m-%d")

colnames(hist_weather)[c(2,4,20)] <- c('MaxTemp', 'MinTemp', 'PrecipInT')
```


Remove duplicates. Strangely, they were all from Lewiston.
130,457 -> 130,091
```{r}
hist_weather <- dplyr::distinct(hist_weather)
```

PrecipIn: Convert PrecipInT column (T for Trace) from char to num. Values that were 'T' went to 0, Values that were '' went to NA. T means Trace Amounts, or <.005 inches.

```{r}
hist_weather$PrecipIn <- hist_weather$PrecipInT
hist_weather$PrecipIn[hist_weather$PrecipIn == 'T'] <- '0'
hist_weather$PrecipIn[hist_weather$PrecipIn == ''] <- NA
hist_weather$PrecipIn <- as.numeric(hist_weather$PrecipIn)
```


There are multiple observations (weather station instrument reads) per city+date. Aggregate with mean by city+date.

```{r}
hist_weather <- as.data.table(hist_weather)
hist_weather_agg <- hist_weather[, j = list(MaxTemp=mean(MaxTemp, na.rm=T), MinTemp=mean(MinTemp, na.rm=T), 
                                  Max_Dew_PointF=mean(Max_Dew_PointF, na.rm=T), 
                                  MeanDew_PointF=mean(MeanDew_PointF, na.rm=T),
                                  Min_DewpointF=mean(Min_DewpointF, na.rm=T), 
                                  Max_Humidity=mean(Max_Humidity, na.rm=T),
                                  Mean_Humidity=mean(Mean_Humidity, na.rm=T), 
                                  Min_Humidity=mean(Min_Humidity, na.rm=T),
                                  Max_Sea_Level_PressureIn=mean(Max_Sea_Level_PressureIn, na.rm=T),
                                  Mean_Sea_Level_PressureIn=mean(Mean_Sea_Level_PressureIn, na.rm=T),
                                  Min_Sea_Level_PressureIn=mean(Min_Sea_Level_PressureIn, na.rm=T), 
                                  Max_VisibilityMiles=mean(Max_VisibilityMiles, na.rm=T),
                                  Mean_VisibilityMiles=mean(Mean_VisibilityMiles, na.rm=T), 
                                  Min_VisibilityMiles=mean(Min_VisibilityMiles, na.rm=T),
                                  Max_Wind_SpeedMPH=mean(Max_Wind_SpeedMPH, na.rm=T), 
                                  Mean_Wind_SpeedMPH=mean(Mean_Wind_SpeedMPH, na.rm=T),
                                  Max_Gust_SpeedMPH=mean(Max_Gust_SpeedMPH, na.rm=T), 
                                  PrecipIn=mean(PrecipIn, na.rm=T), CloudCover=mean(CloudCover, na.rm=T),
                                  WindDirDegrees=mean(WindDirDegrees, na.rm=T)),
                                  by = list(city, Date)]
```



Remove cloud cover outlier. 1 obs is -440, compared to all other values which are between 0 and 8.
```{r}
hist_weather_agg$CloudCover[hist_weather_agg$CloudCover<0] <- 0
```


## Join datasets for export

Also remove dataframes that aren't needed in subsequent rmd.

```{r}
weather_export <- inner_join(forecast_2, hist_weather_agg,
                             by = c("city" = "city", "target_date" = "Date"))

rm(forecast, forecast_wide)
```


